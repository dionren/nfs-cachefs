name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build with Docker
        run: |
          chmod +x build/docker-build.sh
          ./build/docker-build.sh

      - name: Verify build artifacts
        run: |
          ls -la *.tar.gz*
          docker images | grep nfs-cachefs

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cat > release_notes.md << EOF
          # NFS-CacheFS v$VERSION
          
          ## ðŸ“¦ å®‰è£…æ–¹æ³•
          
          ### é¢„ç¼–è¯‘äºŒè¿›åˆ¶åŒ…ï¼ˆæŽ¨èï¼‰
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/nfs-cachefs-v$VERSION-linux-x86_64.tar.gz
          tar -xzf nfs-cachefs-v$VERSION-linux-x86_64.tar.gz
          cd nfs-cachefs-v$VERSION-linux-x86_64
          sudo ./install.sh
          \`\`\`
          
          ## ðŸ” æ ¡éªŒå’Œ
          \`\`\`bash
          sha256sum -c nfs-cachefs-v$VERSION-linux-x86_64.tar.gz.sha256
          \`\`\`
          
          ## ðŸ“‹ æ›´æ–°å†…å®¹
          $(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1)
          
          ## ðŸ› ï¸ æŠ€æœ¯ä¿¡æ¯
          - **æž„å»ºæ–¹å¼**: Docker æž„å»ºï¼ˆrust:1.78-alpineï¼‰
          - **ç›®æ ‡å¹³å°**: Linux x86_64
          - **é“¾æŽ¥æ–¹å¼**: é™æ€é“¾æŽ¥ï¼ˆmusl libcï¼‰
          - **é•œåƒå¤§å°**: çº¦ 24MB
          - **å…¼å®¹æ€§**: æ‰€æœ‰ Linux å‘è¡Œç‰ˆ
          
          ## ðŸ“– æ–‡æ¡£
          - [å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}#å¿«é€Ÿå¼€å§‹)
          - [å‘å¸ƒæµç¨‹](https://github.com/${{ github.repository }}/blob/main/docs/RELEASE_PROCESS.md)
          - [æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: NFS-CacheFS v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            nfs-cachefs-v${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz
            nfs-cachefs-v${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        run: |
          rm -f *.tar.gz *.tar.gz.sha256 release_notes.md
          docker system prune -f 